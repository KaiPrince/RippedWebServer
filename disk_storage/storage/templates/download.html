<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Download</title>
  </head>
  <body>
    <script src="https://cdn.jsdelivr.net/webtorrent/latest/webtorrent.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web-streams-polyfill@2.0.2/dist/ponyfill.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/streamsaver@2.0.5/StreamSaver.min.js"></script>
    <script
      src="https://code.jquery.com/jquery-3.5.1.min.js"
      integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
      crossorigin="anonymous"
    ></script>
    <!-- <script src="{{ url_for('static', filename='js/StreamSaver.js') }}"></script> -->
    <script
      src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"
      integrity="sha256-yr4fRk/GU1ehYJPAs8P4JlTgu0Hdsp4ZKrx8bDEDC3I="
      crossorigin="anonymous"
    ></script>
    <script>
      $(() => {
        const fileStream = streamSaver.createWriteStream("{{ file_name }}");

        var socket = io();
        socket.on("connect", function () {
          console.log("connected!");
          //   socket.emit("my event", { data: "I'm connected!" });
          window.writer = fileStream.getWriter();
        });

        socket.on("data", (data) => {
          console.log("got data", data);

          //   var encode = TextEncoder.prototype.encode.bind(new TextEncoder());
          //   let text = encode(data);

          text = new Uint8Array(data);
          window.writer.write(text);

          //   const readableStream = res.body;

          // more optimized
          //   if (window.WritableStream && readableStream.pipeTo) {
          //     return readableStream
          //       .pipeTo(fileStream)
          //       .then(() => console.log("done writing"));
          //   }

          //   window.writer = fileStream.getWriter();

          //   const reader = res.body.getReader();
          //   const pump = () =>
          //     reader
          //       .read()
          //       .then((res) =>
          //         res.done ? writer.close() : writer.write(res.value).then(pump)
          //       );

          //   pump();
        });

        socket.on("done", () => {
          console.log("closing");
          window.writer.close();
        });
      });
    </script>
  </body>
</html>
